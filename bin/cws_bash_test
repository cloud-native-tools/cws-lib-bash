#!/usr/bin/env bash

# CWS-Lib-Bash Test Runner
# 
# This script runs all available test cases for cws-lib-bash functions
# Usage: ./bin/cws_bash_test [test_name]

set -euo pipefail

# Get the script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "${SCRIPT_DIR}")"
TEST_DIR="${PROJECT_ROOT}/test"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CLEAR='\033[0m'

function usage() {
  echo "Usage: $0 [test_name]"
  echo ""
  echo "Available tests:"
  if [ -d "${TEST_DIR}" ]; then
    for test_file in "${TEST_DIR}"/test_*.sh; do
      if [ -f "${test_file}" ]; then
        local test_name=$(basename "${test_file}" .sh)
        echo "  ${test_name}"
      fi
    done
  else
    echo "  No test directory found at ${TEST_DIR}"
  fi
  echo ""
  echo "Examples:"
  echo "  $0                # Run all tests"
  echo "  $0 test_env       # Run only environment variable tests"
  echo "  $0 test_log       # Run only logging tests"
}

function log_info() {
  echo -e "${BLUE}[INFO]${CLEAR} $*"
}

function log_success() {
  echo -e "${GREEN}[SUCCESS]${CLEAR} $*"
}

function log_error() {
  echo -e "${RED}[ERROR]${CLEAR} $*"
}

function log_warn() {
  echo -e "${YELLOW}[WARN]${CLEAR} $*"
}

function run_test() {
  local test_file=$1
  local test_name=$(basename "${test_file}" .sh)
  
  log_info "Running ${test_name}..."
  
  if [ ! -f "${test_file}" ]; then
    log_error "Test file not found: ${test_file}"
    return 1
  fi
  
  if [ ! -x "${test_file}" ]; then
    chmod +x "${test_file}"
  fi
  
  echo "========================================"
  echo "Running ${test_name}"
  echo "========================================"
  
  if "${test_file}"; then
    log_success "${test_name} passed"
    return 0
  else
    log_error "${test_name} failed"
    return 1
  fi
}

function run_all_tests() {
  local total_tests=0
  local passed_tests=0
  local failed_tests=0
  
  log_info "Running all tests in ${TEST_DIR}"
  
  if [ ! -d "${TEST_DIR}" ]; then
    log_error "Test directory not found: ${TEST_DIR}"
    exit 1
  fi
  
  for test_file in "${TEST_DIR}"/test_*.sh; do
    if [ -f "${test_file}" ]; then
      ((total_tests++))
      if run_test "${test_file}"; then
        ((passed_tests++))
      else
        ((failed_tests++))
      fi
      echo ""
    fi
  done
  
  echo "========================================"
  echo "Test Summary:"
  echo "  Total test files: ${total_tests}"
  echo "  Passed: ${passed_tests}"
  echo "  Failed: ${failed_tests}"
  echo "========================================"
  
  if [ ${failed_tests} -eq 0 ]; then
    log_success "All test files passed!"
    return 0
  else
    log_error "${failed_tests} test file(s) failed!"
    return 1
  fi
}

function main() {
  # Change to project root directory
  cd "${PROJECT_ROOT}"
  
  case ${1:-""} in
    -h|--help|help)
      usage
      exit 0
      ;;
    "")
      # Run all tests
      run_all_tests
      ;;
    *)
      # Run specific test
      local test_name="$1"
      local test_file="${TEST_DIR}/${test_name}.sh"
      
      if [[ ! "${test_name}" =~ ^test_ ]]; then
        test_file="${TEST_DIR}/test_${test_name}.sh"
      fi
      
      run_test "${test_file}"
      ;;
  esac
}

# Run main function with all arguments
main "$@"
